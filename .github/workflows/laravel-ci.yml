# File: .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ⭐️ NEW DEBUGGING STEP ⭐️
      # This step will help us see if the secret is being passed to the action.
      - name: Check if SSH_PRIVATE_KEY is set
        run: |
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "❌ SSH_PRIVATE_KEY is NOT set. Please check your repository secrets."
            exit 1
          else
            echo "✅ SSH_PRIVATE_KEY is set. The key is being passed to the next step."
          fi

      # The main deployment step remains the same.
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/test-prime-it
            echo "Pulling latest code from GitHub..."
            git pull origin main
            echo "Building Docker images on the server..."
            docker-compose build --no-cache
            echo "Restarting application with new images..."
            docker-compose up -d --remove-orphans
            echo "Running post-deployment commands..."
            docker-compose exec -T laravel-prim-it composer install --no-interaction --no-dev --prefer-dist
            docker-compose exec -T laravel-prim-it php artisan migrate --force
            docker-compose exec -T laravel-prim-it php artisan config:cache
            docker-compose exec -T laravel-prim-it php artisan route:cache
            docker-compose exec -T laravel-prim-it php artisan view:cache
            echo "Cleaning up old Docker images..."
            docker image prune -af
            echo "Deployment successful!"
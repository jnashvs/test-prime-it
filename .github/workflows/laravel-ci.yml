name: Build, test and deploy

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ==================================
      # Your Build & Test Steps (No Changes)
      # ==================================
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3

      - name: Create database
        run: touch database/database.sqlite
        working-directory: src

      - name: Copy .env
        run: cp .env.test .env
        working-directory: src

      - name: Install app
        run: composer install
        working-directory: src

      - name: Install Node.js dependencies
        run: npm ci
        working-directory: src

      - name: Build Vite assets
        run: npm run build
        working-directory: src

      - name: Run migrations
        run: php artisan migrate
        working-directory: src

      - name: Run seeders
        run: php artisan db:seed
        working-directory: src

      - name: Run Unit Test & Feature Test
        run: ./vendor/bin/phpunit
        working-directory: src

      # ==================================
      # Debugging & Deployment Steps
      # ==================================

      # ‚≠êÔ∏è 1. NEW DEBUGGING STEP
      - name: Verify Secrets are Passed
        run: |
          echo "Username being used: ${{ secrets.SSH_USERNAME }}"
          if [ -z "${{ secrets.SSH_PASSWORD }}" ]; then
            echo "‚ùå SSH_PASSWORD secret is NOT set."
            exit 1
          else
            echo "‚úÖ SSH_PASSWORD secret is set and will be used."
          fi

      # üõ†Ô∏è 2. SIMPLIFIED & FIXED DEPLOYMENT STEP
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.ROOT }}
          password: ${{ secrets.PASSWORD }}
          script: |
            # Navigate to the correct directory
            cd ~/test-prime-it/src

            # [1/5] Pulling from GitHub
            echo "[1/5] Pulling from GitHub..."
            git pull origin main

            # [2/5] Installing packages
            echo "[2/5] Installing packages..."
            composer install --no-dev --optimize-autoloader
            npm ci
            npm run build

            # [3/5] Running database migrations
            echo "[3/5] Running database migrations..."
            php artisan migrate --force

            # [4/5] Running seeders
            echo "[4/5] Running seeders..."
            php artisan db:seed --force
            
            # [5/5] Caching for performance
            echo "[5/5] Caching for performance..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            echo "‚úÖ Deployment successful!"